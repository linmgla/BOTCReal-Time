<script>
    // Google Sheets CSV 連結
    const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8GSdmGL5ggYr0ADz2fwltf9mBgv-77ggRneKQOBnebWG9HGOwsqpbhn5wpYgrezLHUNwIxi1ACm5r/pub?output=csv';
    
    // 地點顏色配置
    const locationConfig = {
        "101鐘樓": {
            color: "#4dabf7",
            bgColor: "#e7f5ff",
            borderColor: "#4dabf7",
            hiddenColor: "#f0f8ff",
            hiddenBorder: "#a5d8ff"
        },
        "歪常研究院": {
            color: "#da77f2",
            bgColor: "#f8f0fc",
            borderColor: "#da77f2",
            hiddenColor: "#fdf2ff",
            hiddenBorder: "#e599f7"
        },
        "小怪寶家長會": {
            color: "#3a8c4a",
            bgColor: "#e6f7e9",
            borderColor: "#3a8c4a",
            hiddenColor: "#f0f9f2",
            hiddenBorder: "#a3d9b1"
        }
    };

    // 隱藏的地點（默認都顯示）
    let hiddenLocations = new Set();
    // 活動數據
    let eventData = [];
    
    // 從Google Sheets獲取數據
    async function fetchEventData() {
        try {
            const response = await fetch(GOOGLE_SHEETS_CSV_URL);
            const csvText = await response.text();
            
            // 解析CSV數據
            const rows = csvText.split('\n');
            
            // 跳過標題行並處理每一行數據
            eventData = [];
            
            // 從第二行開始（索引1），跳過標題行
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].trim();
                if (!row) continue; // 跳過空行
                
                // 更簡單的CSV解析方法
                const columns = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < row.length; j++) {
                    const char = row[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        columns.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // 添加最後一列
                columns.push(current.trim());
                
                // 確保有足夠的列（至少6列）
                if (columns.length >= 6) {
                    const dateTimeStr = columns[0];
                    const timeStr = columns[1];
                    const location = columns[2] || '';
                    const script = columns[3] || '';
                    const storyteller = columns[4] || '';
                    const link = columns[5] || '';
                    
                    // 解析日期和時間
                    let date = '';
                    let time = '';
                    
                    // 解析日期（從第一欄）
                    if (dateTimeStr) {
                        // 嘗試多種日期格式
                        date = parseDate(dateTimeStr);
                    }
                    
                    // 解析時間（從第二欄）
                    if (timeStr) {
                        time = parseTime(timeStr);
                    }
                    
                    // 只添加有基本資訊的活動
                    if (date && location && script) {
                        eventData.push({
                            date,
                            time,
                            location,
                            script,
                            storyteller,
                            link
                        });
                    }
                }
            }
            
            console.log('成功從Google Sheets載入', eventData.length, '個活動');
            return true;
        } catch (error) {
            console.error('從Google Sheets獲取數據時發生錯誤:', error);
            return false;
        }
    }
    
    // 解析日期（支援多種格式）
    function parseDate(dateStr) {
        if (!dateStr) return '';
        
        // 移除多餘的空格和特殊字符
        dateStr = dateStr.toString().trim();
        
        // 嘗試匹配常見的日期格式
        const datePatterns = [
            /(\d{4})[-/年](\d{1,2})[-/月](\d{1,2})/,  // YYYY-MM-DD, YYYY/MM/DD, YYYY年MM月DD日
            /(\d{1,2})[-/月](\d{1,2})[-/年](\d{4})/,  // DD-MM-YYYY, DD/MM/YYYY, DD月MM年YYYY
            /(\d{4})(\d{2})(\d{2})/,                   // YYYYMMDD
        ];
        
        for (const pattern of datePatterns) {
            const match = dateStr.match(pattern);
            if (match) {
                let year, month, day;
                
                if (pattern === datePatterns[0]) {
                    // YYYY-MM-DD 格式
                    year = parseInt(match[1]);
                    month = parseInt(match[2]);
                    day = parseInt(match[3]);
                } else if (pattern === datePatterns[1]) {
                    // DD-MM-YYYY 格式
                    day = parseInt(match[1]);
                    month = parseInt(match[2]);
                    year = parseInt(match[3]);
                } else if (pattern === datePatterns[2]) {
                    // YYYYMMDD 格式
                    year = parseInt(match[1]);
                    month = parseInt(match[2]);
                    day = parseInt(match[3]);
                }
                
                // 確保月份和日期是兩位數
                const formattedMonth = month.toString().padStart(2, '0');
                const formattedDay = day.toString().padStart(2, '0');
                
                return `${year}-${formattedMonth}-${formattedDay}`;
            }
        }
        
        // 嘗試使用JavaScript的Date物件解析
        const parsedDate = new Date(dateStr);
        if (!isNaN(parsedDate.getTime())) {
            const year = parsedDate.getFullYear();
            const month = (parsedDate.getMonth() + 1).toString().padStart(2, '0');
            const day = parsedDate.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        console.warn('無法解析日期:', dateStr);
        return '';
    }
    
    // 解析時間（支援多種格式）
    function parseTime(timeStr) {
        if (!timeStr) return '';
        
        // 移除多餘的空格和特殊字符
        timeStr = timeStr.toString().trim();
        
        // 嘗試匹配常見的時間格式
        const timePatterns = [
            /(\d{1,2}):(\d{2}):(\d{2})/,      // HH:MM:SS
            /(\d{1,2}):(\d{2})/,              // HH:MM
            /(\d{1,2})時(\d{2})分(\d{2})秒/,   // HH時MM分SS秒
            /(\d{1,2})時(\d{2})分/,            // HH時MM分
            /(\d{1,2})[:時](\d{2})/,           // HH:MM 或 HH時MM
        ];
        
        for (const pattern of timePatterns) {
            const match = timeStr.match(pattern);
            if (match) {
                let hour = parseInt(match[1]);
                const minute = match[2] ? parseInt(match[2]) : 0;
                const second = match[3] ? parseInt(match[3]) : 0;
                
                // 處理12小時制（如果有AM/PM標示）
                if (timeStr.toLowerCase().includes('pm') && hour < 12) {
                    hour += 12;
                } else if (timeStr.toLowerCase().includes('am') && hour === 12) {
                    hour = 0;
                }
                
                // 確保小時、分鐘、秒數是兩位數
                const formattedHour = hour.toString().padStart(2, '0');
                const formattedMinute = minute.toString().padStart(2, '0');
                const formattedSecond = second.toString().padStart(2, '0');
                
                return `${formattedHour}:${formattedMinute}:${formattedSecond}`;
            }
        }
        
        // 如果是純數字（如 2000 代表 20:00）
        const numMatch = timeStr.match(/^(\d{3,4})$/);
        if (numMatch) {
            const num = parseInt(numMatch[1]);
            if (num >= 0 && num <= 2359) {
                const hour = Math.floor(num / 100);
                const minute = num % 100;
                if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                    return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`;
                }
            }
        }
        
        console.warn('無法解析時間:', timeStr);
        return '';
    }
    
    // 輔助函數：格式化日期為 YYYY-MM-DD
    function formatDateToYYYYMMDD(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // 檢查日期是否已過期
    function isDatePassed(eventDate, eventTime) {
        const now = new Date();
        
        // 如果時間為空，只比較日期（不包含時間）
        if (!eventTime || eventTime.trim() === "") {
            const eventDateOnly = new Date(eventDate);
            eventDateOnly.setHours(0, 0, 0, 0);
            
            const nowDateOnly = new Date();
            nowDateOnly.setHours(0, 0, 0, 0);
            
            // 比較日期（不包含時間）
            return nowDateOnly > eventDateOnly;
        }
        
        // 如果有時間，則比較完整的日期時間
        const eventDateTime = new Date(`${eventDate}T${eventTime}`);
        return now > eventDateTime;
    }
    
    // 初始化函數
    async function init() {
        // 顯示載入訊息
        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">正在從Google Sheets載入資料...</div>';
        
        // 從Google Sheets獲取數據
        const success = await fetchEventData();
        
        if (success) {
            generateFilterButtons();
            generateCalendar();
            setupModalEvents();
            updateStatusBar();
        } else {
            calendarGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #dc3545;">無法從Google Sheets載入資料，請稍後再試。</div>';
        }
    }
    
    // 其餘的函數保持不變...
    // （setupModalEvents、showTooltip、removeTooltip、showEventModal、
    //  generateFilterButtons、toggleLocation、updateStatusBar、
    //  generateCalendar、getEventsForDate、createCalendarData 等函數）
    
    // 頁面加載時初始化
    document.addEventListener('DOMContentLoaded', init);
    
    // 每5分鐘自動重新整理資料
    setInterval(async () => {
        console.log('自動更新資料...');
        await fetchEventData();
        generateFilterButtons();
        generateCalendar();
        updateStatusBar();
    }, 5 * 60 * 1000);
</script>
